<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/boxicons/2.1.4/css/boxicons.min.css" />
  <link rel="stylesheet" href="style.css" />

</head>
<body>
  <div class="wrapper">
    <form id="loginForm">
      <h1>Login</h1>

      <div id="errorMessage"></div>

      <div class="input-box">
        <input type="text" id="username" placeholder="Username" required />
        <i class='bx bxs-user'></i>
      </div>

      <div class="input-box">
        <input type="password" id="password" placeholder="Password" required />
        <i class='bx bx-show' id="togglePassword" title="Mostrar/Ocultar contrase√±a"></i>
        <i class='bx bxs-lock'></i>
      </div>

      <div class="remember-forgot">
        <label><input type="checkbox" /> Remember me</label>
        <a href="#">Forgot Password?</a>
      </div>

      <button type="submit" class="btn">Login</button>

      <div class="register-link">
        <p>Don't have an account? <a href="registro.html">Register</a></p>
      </div>
    </form>
  </div>

<script>
  // Funci√≥n para obtener usuarios registrados del localStorage
  function obtenerUsuarios() {
    const usuarios = localStorage.getItem('usuariosRegistrados');
    if (usuarios) {
      return JSON.parse(usuarios);
    } else {
      // Usuarios por defecto si no hay registros
      const usuariosPorDefecto = {
        admin: { password: "1234", role: "admin", fullName: "Administrador", email: "admin@admin.com" },
        usua1: { password: "4321", role: "user", fullName: "Usuario 1", email: "user1@test.com" }
      };
      localStorage.setItem('usuariosRegistrados', JSON.stringify(usuariosPorDefecto));
      return usuariosPorDefecto;
    }
  }

  // Variables para controlar intentos
  let intentosFallidos = parseInt(localStorage.getItem('intentosFallidos')) || 0;
  let tiempoBloqueado = parseInt(localStorage.getItem('tiempoBloqueado')) || 0;

  // Mostrar/Ocultar contrase√±a
  const togglePassword = document.getElementById('togglePassword');
  const passwordField = document.getElementById('password');

  togglePassword.addEventListener('click', function () {
    if (passwordField.type === 'password') {
      passwordField.type = 'text';
      togglePassword.classList.remove('bx-show');
      togglePassword.classList.add('bx-hide');
    } else {
      passwordField.type = 'password';
      togglePassword.classList.remove('bx-hide');
      togglePassword.classList.add('bx-show');
    }
  });

  // Mostrar errores visuales
  function mostrarError(mensaje, tipo = 'error') {
    const errorDiv = document.getElementById('errorMessage');
    errorDiv.style.display = 'block';
    errorDiv.textContent = mensaje;

    if (tipo === 'warning') {
      errorDiv.style.backgroundColor = '#fff3cd';
      errorDiv.style.borderColor = '#ffeeba';
      errorDiv.style.color = '#856404';
    } else {
      errorDiv.style.backgroundColor = '#f8d7da';
      errorDiv.style.borderColor = '#f5c6cb';
      errorDiv.style.color = '#721c24';
    }

    setTimeout(() => {
      errorDiv.style.display = 'none';
    }, 5000);
  }

  // Manejo de login
  document.getElementById("loginForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const ahora = Date.now();
    if (tiempoBloqueado && ahora < tiempoBloqueado) {
      const tiempoRestante = Math.ceil((tiempoBloqueado - ahora) / 1000);
      mostrarError(`üîí Demasiados intentos fallidos. Intenta de nuevo en ${tiempoRestante} segundos.`);
      return;
    }

    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value;

    if (!username || !password) {
      mostrarError("Por favor, completa todos los campos", 'warning');
      return;
    }

    // Obtener usuarios registrados
    const users = obtenerUsuarios();

    if (users[username] && users[username].password === password) {
      // √âxito
      intentosFallidos = 0;
      tiempoBloqueado = 0;
      localStorage.removeItem('intentosFallidos');
      localStorage.removeItem('tiempoBloqueado');

      localStorage.setItem("rolUsuario", users[username].role);
      localStorage.setItem("usuarioActual", username);

      if (users[username].role === "admin") {
        window.location.href = "admin.html";
      } else {
        window.location.href = "inicio2.html";
      }

    } else {
      intentosFallidos++;
      localStorage.setItem('intentosFallidos', intentosFallidos);

      if (intentosFallidos >= 5) {
        tiempoBloqueado = Date.now() + (2 * 60 * 1000);
        localStorage.setItem('tiempoBloqueado', tiempoBloqueado);
        mostrarError('‚ÄºÔ∏è Has excedido el n√∫mero m√°ximo de intentos. Acceso bloqueado por 2 minutos.');
      } else if (intentosFallidos >= 3) {
        mostrarError(`‚ö†Ô∏è ${intentosFallidos}/5 intentos fallidos. Ten cuidado.`, 'warning');
      } else {
        mostrarError(`‚ùå Usuario o contrase√±a incorrecta. Intentos ${intentosFallidos}/5`);
      }
    }
  });
</script>
</body>
</html>
